using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.IO;
using System.Threading;

namespace Actemium.WiSSWizard.Pages
{
    public partial class CheckCurrentSafety : BaseFormPage
    {
        const string CLASSNAME = "CheckCurrentSafety";
        private List<PictureBox> _controlpbList = new List<PictureBox>();
        public enum controlSteps
        {
            start,
            passWordPolicy,
            controlPolicy,
            addUserGroup,
            addUser,
            autoPlaySettings,
            explorerMapOptions,
            AutologInSettings,
            ShutDownEventTracker,
            remoteDesktop,
            sharing,
            fireWall,
            configPcAnywhere,
            configBlockKeys,
            configSQLserver,
            configWebserver,
            configFTPserver,
            configMailserver,
            configMBSA,
            end
        };
        private FileHandling _fh;
        private ScriptHandling _sh;
        private ConfigClass _configClass;
        private CtrlHome _ctrlHome;
        private MainProgram _mainProgram;
        private string _controlFilePath = "";
        private bool _running = true;
        private BackgroundWorker m_AsyncWorker = new BackgroundWorker();
        string lastStepBeforeQuit = null;
                
        
        public CheckCurrentSafety(CtrlHome ctrlhome , ConfigClass configClass)
        {
            InitializeComponent();
            _ctrlHome = ctrlhome;
            _mainProgram = new MainProgram(CtrlHome.GetConfigClass);
            _sh = CtrlHome.GetConfigClass.GetScriptHandling;
            _configClass = configClass;
            _fh = new FileHandling(_configClass);
            #region MainProgram images init
            _controlpbList.Add(pbConfigCheck1);
            _controlpbList.Add(pbConfigCheck2);
            _controlpbList.Add(pbConfigCheck3);
            _controlpbList.Add(pbConfigCheck4);
            _controlpbList.Add(pbConfigCheck5);
            _controlpbList.Add(pbConfigCheck6);
            _controlpbList.Add(pbConfigCheck7);
            _controlpbList.Add(pbConfigCheck8);
            _controlpbList.Add(pbConfigCheck9);
            _controlpbList.Add(pbConfigCheck10);
            _controlpbList.Add(pbConfigCheck11);

            _controlpbList[0].Image = checkImages.Images[3];
            setPboxImages(1,true);
            #endregion MainProgram images init
            
        }

        public void setPboxImages(int start, bool init)
        {
            for (int i = start-1; i < _controlpbList.Count; i++)
            {
                if (init)
                {
                    _controlpbList[i].Image = checkImages.Images[3];
                }
                else
                {
                    _controlpbList[i].Image = checkImages.Images[2];
                }

            }


            if (!CtrlHome.GetConfigClass.ConfInstalledSoftware.IsApplicationInstalled("Microsoft Baseline Security Analyzer"))
            {
                pbConfigCheck11.Image = checkImages.Images[5];
            }
        }

        #region Init
        #region ControlfileHeaders
        private string CFHSelectNameAndSystem = "Algemene informatie:";
        private string CFHInstalledApllications = "Geinstalleerde Software:";
        private string CFHPasswordPolicy = "Wachtwoord beleid:";
        private string CFHControlPolicy = "Controle beleid:";
        private string CFHGroups = "Windows gebruikersgroepen";
        private string CFHUsers = "Windows gebruikers";
        private string CFHAutoPlay = "Autoplay settings:";
        private string CFHExplorer = "Windows Explorer settings:";
        private string CFHAutoLogon = "AutoLogon settings:";
        private string CFHshutDownEventTracker = "Shutdown eventtracker settings:";
        private string CFHremoteDesktop = "Remote Desktop settings:";
        private string CFHsharing = "wpSharing";
        private string CFHfirewall = "Firewall settings:";
        private string CFHPcAnywhere = "wpPcAnywhere";
        private string CFHBlockKeys = "wpBlockKeys";
        private string CFHSQLserver = "wpSQLserver";
        private string CFHWebServer = "wpWebServer";
        private string CFHFTPserver = "wpFTPserver";
        private string CFHMailServer = "wpMailServer";
        private string CFHMBSA = "wpMBSA";
        #endregion ControlfileHeaders
        public void Init()
        {
            #region createLogfile init
            _controlFilePath = System.IO.Path.GetDirectoryName(Application.ExecutablePath) + @"\currentControl\";
            _fh = new FileHandling(_configClass);
            _fh.FilePath = _controlFilePath + _fh.CreateFileName(".txt");
            _fh.CreateFile(_fh.FilePath.ToString());

            _controlFilePath = _fh.FilePath;
            DateTime dt = DateTime.Now;
            _fh.AddLineToEndFile(_controlFilePath, "Huidige veiligheids instellingen van uw systeem");
            _fh.AddLineToEndFile(_controlFilePath, "            " + dt.DayOfWeek + " " + dt.Day + "-" + dt.Month + "-" + dt.Year);

            #endregion createLogfile init

            #region MainProgram images init
                     
            foreach (PictureBox pb in _controlpbList)
            {
                pb.Image = checkImages.Images[3];
            }

            if (!CtrlHome.GetConfigClass.ConfInstalledSoftware.IsApplicationInstalled("Microsoft Baseline Security Analyzer"))
            {
                pbConfigCheck11.Image = checkImages.Images[5];
            }

            #endregion MainProgram images init
        }
        #endregion Init

        private void btStart_Click(object sender, EventArgs e)
        {
            Init();
            btStart.Enabled = false;
            btStop.Enabled = true;
            btClose.Enabled = false;
            _running = true;
            backgroundWorker1.RunWorkerAsync();
            
        }

        private void btStop_Click(object sender, EventArgs e)
        {
            btStart.Enabled = true;
            btStop.Enabled = false;
            
            if (backgroundWorker1.WorkerSupportsCancellation == true)
            {
                backgroundWorker1.CancelAsync();
            }
            _running = false;

            btClose.Enabled = true;
            CtrlHome.GetConfigClass.ConfSetMicrosoftBaslineSecurityAnalyzer.KillMBSAProcessesByClosing("mbsacli");
        }

        private void btClose_Click(object sender, EventArgs e)
        {
            CtrlHome.GetConfigClass.ConfSetMicrosoftBaslineSecurityAnalyzer.KillMBSAProcessesByClosing("mbsacli");
            string mbsaLog = System.IO.Path.GetDirectoryName(Application.ExecutablePath) + "\\MBSAlog.txt";
            if(File.Exists(mbsaLog))
            {
            File.Delete(mbsaLog);
            }
            this.Close();
        }

        private void btViewRapport_Click(object sender, EventArgs e)
        {
            System.Diagnostics.Process.Start(_controlFilePath);
        }

        public void MakeControl(string logFilePath, controlSteps cs, Actemium.WiSSWizard.Support.OSVersions os,ConfigClass configClass)
        {
            if (_running)
            {
                switch (cs)
                {
                    case controlSteps.start:
                        #region
                    MakeControl(logFilePath, controlSteps.passWordPolicy, os, configClass);
                        #endregion
                        break;
                    case controlSteps.passWordPolicy:
                        #region
                        pbConfigCheck1.Image = checkImages.Images[1];
                        if (MakePassWordPolicyControl(logFilePath, os))
                        {
                            pbConfigCheck1.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck1.Image = checkImages.Images[2];
                        }

                        MakeControl(logFilePath, controlSteps.controlPolicy, os, configClass);
                        #endregion
                        break;
                    case controlSteps.controlPolicy:
                        #region
                        pbConfigCheck2.Image = checkImages.Images[1];
                        if (MakeAuditPolicyControl(logFilePath, os))
                        {
                            pbConfigCheck2.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck2.Image = checkImages.Images[2];
                        }

                        MakeControl(logFilePath, controlSteps.addUserGroup, os, configClass);
                        #endregion
                        break;
                    case controlSteps.addUserGroup:
                        #region
                        pbConfigCheck3.Image = checkImages.Images[1];
                        if (MakeUserGroupControl(logFilePath, os))
                        {
                            pbConfigCheck3.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck3.Image = checkImages.Images[2];
                        }
                        MakeControl(logFilePath, controlSteps.addUser, os, configClass);
                        #endregion
                        break;
                    case controlSteps.addUser:
                        #region
                        pbConfigCheck4.Image = checkImages.Images[1];
                        if (MakeUserControl(logFilePath, os))
                        {
                            pbConfigCheck4.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck4.Image = checkImages.Images[2];
                        }
                        MakeControl(logFilePath, controlSteps.autoPlaySettings, os, configClass);
                        #endregion
                        break;
                    case controlSteps.autoPlaySettings:
                        #region
                        pbConfigCheck5.Image = checkImages.Images[1];
                        if (MakeAutoPlayControl(logFilePath, os))
                        {
                            pbConfigCheck5.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck5.Image = checkImages.Images[2];
                        }
                        MakeControl(logFilePath, controlSteps.explorerMapOptions, os, configClass);
                        #endregion
                        break;
                    case controlSteps.explorerMapOptions:
                        #region
                        pbConfigCheck6.Image = checkImages.Images[1];
                        if (MakeExplorerFolderOptionsControl(logFilePath, os))
                        {
                            pbConfigCheck6.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck6.Image = checkImages.Images[2];
                        }
                        MakeControl(logFilePath, controlSteps.AutologInSettings, os, configClass);
                        #endregion
                        break;
                    case controlSteps.AutologInSettings:
                        #region
                        pbConfigCheck7.Image = checkImages.Images[1];
                        if (MakeAutoLogInControl(logFilePath, os))
                        {
                            pbConfigCheck7.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck7.Image = checkImages.Images[2];
                            pbConfigCheck8.Image = checkImages.Images[2];
                        }
                        MakeControl(logFilePath, controlSteps.ShutDownEventTracker, os, configClass);
                        #endregion
                        break;
                    case controlSteps.ShutDownEventTracker:
                        #region
                        pbConfigCheck8.Image = checkImages.Images[1];
                        if (MakeShutdownEventTrackerControl(logFilePath, os))
                        {
                            pbConfigCheck8.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck8.Image = checkImages.Images[2];
                        }
                        MakeControl(logFilePath, controlSteps.remoteDesktop, os, configClass);
                        #endregion
                        break;
                    case controlSteps.remoteDesktop:
                        #region
                        pbConfigCheck9.Image = checkImages.Images[1];
                        if (MakeRemoteDesktopControl(logFilePath, os))
                        {
                            pbConfigCheck9.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck9.Image = checkImages.Images[2];
                        }
                        MakeControl(logFilePath, controlSteps.fireWall, os, configClass);
                        #endregion
                        break;
                    case controlSteps.fireWall:
                        #region
                        pbConfigCheck10.Image = checkImages.Images[1];
                        if (MakeFireWallControl(logFilePath, os))
                        {
                            pbConfigCheck10.Image = checkImages.Images[0];
                        }
                        else
                        {
                            pbConfigCheck10.Image = checkImages.Images[2];
                        }
                        MakeControl(logFilePath, controlSteps.configMBSA, os, configClass);
                        #endregion
                        break;
                    case controlSteps.configMBSA:
                        #region
                        if (CtrlHome.GetConfigClass.ConfInstalledSoftware.IsApplicationInstalled("Microsoft Baseline Security Analyzer"))
                        {
                            pbConfigCheck11.Image = checkImages.Images[1];
                            setLabel("MBSA systeem scannen (Kan enkele minuten duren)");
                            if (MakeMBSAControl(logFilePath, os,configClass))
                            {
                                setLabel("MBSA systeem scannen");
                                pbConfigCheck11.Image = checkImages.Images[0];
                            }
                            else
                            {
                                setLabel("MBSA systeem scannen");
                                pbConfigCheck11.Image = checkImages.Images[2];
                            }
                        }
                        MakeControl(logFilePath, controlSteps.end, os, configClass);
                        #endregion
                        break;
                    case controlSteps.end:
                        break;
                }
            }
            else
            {
                lastStepBeforeQuit = cs.ToString();
                setIconsByclosing(lastStepBeforeQuit);
            }
        }
     
        private bool MakePassWordPolicyControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)///////////////
        {
            return false;
        }

        private bool MakeAuditPolicyControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)//////////////////
        {
            return false;
        }

        private bool MakeUserGroupControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)
        {
            _sh.putAllLocalGroupsToList();
            _fh.AddLineToEndFile(logFilePath, "");
            _fh.AddLineToEndFile(logFilePath, CFHGroups);
            _fh.AddLineToEndFile(logFilePath, "");
            _fh.AddLineToEndFile(logFilePath, "    " + "De volgende gebruikers groepen zijn geinstalleerd op uw systeem:");

            try
            {
                foreach (UserGroup group in _sh.GetAllLocalUsersGroups)
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + group.Name);
                }
                return true;
            }
            catch
            {
                return false;
            }
        }

        private bool MakeUserControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)
        {
            _sh.putAllLocalUsersToList();
            _fh.AddLineToEndFile(logFilePath, "");
            _fh.AddLineToEndFile(logFilePath, CFHUsers);
            _fh.AddLineToEndFile(logFilePath, "");
            _fh.AddLineToEndFile(logFilePath, "    " + "De volgende gebruikers zijn geinstalleerd op uw systeem:");

            try
            {
                foreach (ExistedUser user in _sh.GetAllLocalUsers)
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + user.Name);
                }
                return true;
            }
            catch
            {
                return false;
            }
        }

        private bool MakeAutoPlayControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)
        {

            _fh.AddLineToEndFile(logFilePath, "");
            _fh.AddLineToEndFile(logFilePath, CFHAutoPlay);
            _fh.AddLineToEndFile(logFilePath, "");
            _fh.AddLineToEndFile(logFilePath, "    " + "De AutoPlay instelling op dit systeem is:");

            string regPath = "";
            string regKey = "";
            try
            {
                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "AutoPlaySettingRegPath") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "AutoPlaySettingRegPath");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "AutoPlaySettingRegPath");
                }

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "APRegKeyNoDriveTypeAutoRun") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "APRegKeyNoDriveTypeAutoRun");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "APRegKeyNoDriveTypeAutoRun");
                }

                string value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("255"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "AutoPlay is uitgeschakeld voor alle typen stations");
                    return true;
                }
                if (value.Contains("181"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "AutoPlay is uitgeschakeld voor cd-romstations en verwisselbare media stations");
                    return true;
                }
                if (value.Contains("NULL"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "AutoPlay instellingen zijn niet geconfigureerd");
                    return true;
                }
                return true;
            }
            catch
            {
                return false;
            }

        }

        private bool MakeExplorerFolderOptionsControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)
        {
            try
            {
                _fh.AddLineToEndFile(logFilePath, "");
                _fh.AddLineToEndFile(logFilePath, CFHExplorer);
                _fh.AddLineToEndFile(logFilePath, "");
                _fh.AddLineToEndFile(logFilePath, "    " + "De Map opties op dit systeem zijn:");

                string regPath = "";
                string regKey = "";
                string value = "";

                #region Automatisch naar netwerkmappen en -printers zoeken

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOregPathfolderOptionsAdvanced");
                }
                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMONoNetCrawling") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMONoNetCrawling");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMONoNetCrawling");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Automatisch naar netwerkmappen en -printers zoeken = ON");

                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Automatisch naar netwerkmappen en -printers zoeken = OFF");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Automatisch naar netwerkmappen en -printers zoeken = WAARDE ONBEKEND");
                }

                #endregion
                #region De inhoud van de systeemmappen weergeven

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOregPathfolderOptionsAdvanced");
                }

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOWebViewBarricade") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOWebViewBarricade");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOWebViewBarricade");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "De inhoud van de systeemmappen weergeven = OFF");

                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "De inhoud van de systeemmappen weergeven = ON");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "De inhoud van de systeemmappen weergeven = WAARDE ONBEKEND");
                }

                #endregion
                #region Het volledige pad in de adresbalk weergeven

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsCabinetState") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsCabinetState");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOregPathfolderOptionsCabinetState");
                }

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOFullPathAddress") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOFullPathAddress");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOFullPathAddress");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Het volledige pad in de adresbalk weergeven = OFF");

                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Het volledige pad in de adresbalk weergeven = ON");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Het volledige pad in de adresbalk weergeven = WAARDE ONBEKEND");
                }

                #endregion
                #region Verborgen bestanden en mappen weergeven

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOregPathfolderOptionsAdvanced");
                }

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOHidden") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOHidden");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOHidden");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("2"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Verborgen bestanden en mappen weergeven = OFF");

                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Verborgen bestanden en mappen weergeven = ON");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Verborgen bestanden en mappen weergeven = WAARDE ONBEKEND");
                }

                #endregion
                #region Extensies voor bekende bestandstypen verbergen

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOregPathfolderOptionsAdvanced");
                }

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOHideFileExt") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOHideFileExt");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOHideFileExt");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Extensies voor bekende bestandstypen verbergen = OFF");

                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Extensies voor bekende bestandstypen verbergen = ON");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Extensies voor bekende bestandstypen verbergen = WAARDE ONBEKEND");
                }

                #endregion
                #region Beveiligde besturingssysteembestanden verbergen

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOregPathfolderOptionsAdvanced");
                }

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOShowSuperHidden") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOShowSuperHidden");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOShowSuperHidden");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Beveiligde besturingssysteembestanden verbergen = ON");

                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Beveiligde besturingssysteembestanden verbergen = OFF");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Beveiligde besturingssysteembestanden verbergen = WAARDE ONBEKEND");
                }
                #endregion
                #region De weergave-instellingen van elke map opslaan

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOregPathfolderOptionsAdvanced");
                }

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOClassicViewState") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOClassicViewState");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOClassicViewState");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "De weergave-instellingen van elke map opslaan = ON");

                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "De weergave-instellingen van elke map opslaan = OFF");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "De weergave-instellingen van elke map opslaan = WAARDE ONBEKEND");
                }
                #endregion
                #region Gecodeerde of gecomprimeerde NTFS-bestanden in een andere kleur weergeven

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOregPathfolderOptionsAdvanced");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOregPathfolderOptionsAdvanced");
                }

                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOShowCompColor") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "EMOShowCompColor");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "EMOShowCompColor");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Gecodeerde of gecomprimeerde NTFS-bestanden in een andere kleur weergeven = OFF");
                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Gecodeerde of gecomprimeerde NTFS-bestanden in een andere kleur weergeven = ON");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Gecodeerde of gecomprimeerde NTFS-bestanden in een andere kleur weergeven = WAARDE ONBEKEND");
                }

                #endregion
                return true;
            }
            catch
            {
                return false;
            }
        }

        private bool MakeAutoLogInControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)
        {
            try
            {
                _fh.AddLineToEndFile(logFilePath, "");
                _fh.AddLineToEndFile(logFilePath, CFHAutoLogon);
                _fh.AddLineToEndFile(logFilePath, "");
                _fh.AddLineToEndFile(logFilePath, "    " + "De instellingen voor automatisch inloggen op dit systeem zijn:");

                string regPath = "";
                string regKey = "";
                string value = "";
                #region RegPath
                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "AutoLogonRegPath") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "AutoLogonRegPath");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "AutoLogonRegPath");
                }
                #endregion RegPath

                #region GetAutoLogon
                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "AutoAdminLogon") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "AutoAdminLogon");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "AutoAdminLogon");
                }
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Automatisch inloggen is uitgeschakeld");
                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Automatisch inloggen isgeschakeld voor de volgende gebruiker:");
                    #region Username
                    if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "AutoLogonUsername") != null)
                    {
                        regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "AutoLogonUsername");
                    }
                    else
                    {
                        regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "AutoLogonUsername");
                    }
                    _fh.AddLineToEndFile(logFilePath, "        " + _sh.GetRegkeyValue(regPath, regKey));
                    #endregion  Username
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Status van automatisch inloggen is onbekend");
                }
                #endregion GetAutoLogon
                return true;
            }
            catch
            {
                return false;
            }
        }

        private bool MakeShutdownEventTrackerControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)
        {
            try
            {
                _fh.AddLineToEndFile(logFilePath, "");
                _fh.AddLineToEndFile(logFilePath, CFHshutDownEventTracker);
                _fh.AddLineToEndFile(logFilePath, "");
                _fh.AddLineToEndFile(logFilePath, "    " + "De instellingen voor de shutdown event tracker zijn:");

                string regPath = "";
                string regKey = "";
                string value = "";

                #region RegPath
                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "SDEVTRegPath") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "SDEVTRegPath");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "SDEVTRegPath");
                }
                #endregion RegPath

                #region OnShutdownReasonUI
                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "SDEVTRegKeyOnShutdownReasonUI") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "SDEVTRegKeyOnShutdownReasonUI");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "SDEVTRegKeyOnShutdownReasonUI");
                }
                #endregion OnShutdownReasonUI
               
                value = _sh.GetRegkeyValue(regPath, regKey);
                if (value.Contains("0"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Shutdown event tracker is uitgeschakeld");
                }
                else if (value.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Shutdown event tracker is ingeschakeld");
                }
                else
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Shutdown event tracker is uitgeschakeld");
                }
                return true;
            }
            catch
            { return false; }
        }

        private bool MakeRemoteDesktopControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)
        {

            try
            {
                _fh.AddLineToEndFile(logFilePath, "");
                _fh.AddLineToEndFile(logFilePath, CFHremoteDesktop);
                _fh.AddLineToEndFile(logFilePath, "");
                _fh.AddLineToEndFile(logFilePath, "    " + "De instellingen voor Remotedesktop zijn:");

                string regPath = "";
                string regKey = "";
                string value1 = "";
                string value2 = "";

                #region RegPath
                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "RemoteDesktopEnableLessSecureRegPath") != null)
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "RemoteDesktopEnableLessSecureRegPath");
                }
                else
                {
                    regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "RemoteDesktopEnableLessSecureRegPath");
                }
                #endregion RegPath
                #region RegKeyRemoteDesktop
                if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "RemoteDesktopEnableLessSecureRegKey") != null)
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "RemoteDesktopEnableLessSecureRegKey");
                }
                else
                {
                    regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "RemoteDesktopEnableLessSecureRegKey");
                }
                #endregion RegKeyRemoteDesktop
                value1 = _sh.GetRegkeyValue(regPath, regKey);

                if (os != Actemium.WiSSWizard.Support.OSVersions.WindowsXP && os != Actemium.WiSSWizard.Support.OSVersions.WindowsXP32 && os != Actemium.WiSSWizard.Support.OSVersions.WindowsXP64 && os != Actemium.WiSSWizard.Support.OSVersions.W2003 && os != Actemium.WiSSWizard.Support.OSVersions.W2003R2)
                {
                    #region RegPath Netwerk level authentication
                    if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "RemoteDesktopEnableMoreSecureRegPath") != null)
                    {
                        regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "RemoteDesktopEnableMoreSecureRegPath");
                    }
                    else
                    {
                        regPath = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "RemoteDesktopEnableMoreSecureRegPath");
                    }
                    #endregion RegPath Netwerk level authentication
                    #region RegKeyRemoteDesktop Netwerk level authentication
                    if (Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "RemoteDesktopEnableMoreSecureRegKey") != null)
                    {
                        regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(os, "RemoteDesktopEnableMoreSecureRegKey");
                    }
                    else
                    {
                        regKey = Actemium.WiSSWizard.Support.ResourceHelper.GetOSOperations(Actemium.WiSSWizard.Support.OSVersions.AllOS, "RemoteDesktopEnableMoreSecureRegKey");
                    }
                    #endregion RegKeyRemoteDesktop Netwerk level authentication
                    value2 = _sh.GetRegkeyValue(regPath, regKey);
                }

                if (value1.Contains("1"))
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + "Remote Desktop uitgeschakeld");
                }
                else if (value1.Contains("0"))
                {
                    if (value2.Contains("1"))
                    {
                        _fh.AddLineToEndFile(logFilePath, "        " + "Remote Desktop ingeschakeld, staat alleen connecties toe van computers met met Netwerk level authentication");
                    }
                    else
                    {
                        _fh.AddLineToEndFile(logFilePath, "        " + "Remote Desktop ingeschakeld, staat connecties van alle computers toe");
                    }
                }
                return true;
            }
            catch
            {
                return false;
            }
        }

        private bool MakeSharingControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)/////////////////
        {
            return false;
        }

        private bool MakeFireWallControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)
        {
            _sh.putAllLocalFireWallExceptionsToList();
            _fh.AddLineToEndFile(logFilePath, "");
            _fh.AddLineToEndFile(logFilePath, CFHfirewall);
            _fh.AddLineToEndFile(logFilePath, "");
            try
            {
                foreach (string exception in _sh.GetAllLocalFirewallExceptions)
                {
                    _fh.AddLineToEndFile(logFilePath, "        " + exception);
                }
                return true;
            }
            catch
            {
                return false;
            }
        }

        private bool MakePcAnyWhereControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)////////////////
        {
            return false;
        }

        private bool MakeBlockKeysControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)///////////////////
        {
            return false;
        }

        private bool MakeSQLserverControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)////////////////////
        {
            return false;
        }

        private bool MakeWebServerControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)//////////////////
        {
            return false;
        }

        private bool MakeFTPServerControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)/////////////////
        {
            return false;
        }

        private bool MakeMailServerControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os)//////////////////
        {
            return false;
        }

        private bool MakeMBSAControl(string logFilePath, Actemium.WiSSWizard.Support.OSVersions os, ConfigClass configClass)///////////////////
        {
            try
            {
                
                string path = CtrlHome.GetConfigClass.ConfSetMicrosoftBaslineSecurityAnalyzer.FindMBSAexePath("Microsoft Baseline Security Analyzer",configClass);
                string mbsaLog = System.IO.Path.GetDirectoryName(Application.ExecutablePath) + "\\MBSAlog.txt";
                bool check = false;
                File.Delete(mbsaLog);
                if (path != null)
                {
                    _sh.RunMBSA(path, "\"" + mbsaLog + "\"");
                    foreach (string st in _fh.ReadWholeFile(mbsaLog))
                    {
                        _fh.AddLineToEndFile(logFilePath, st);
                    }
                    check = true;
                }
                else
                {
                    check = false;
                }

                return check;
            }
            catch
            {
                return false;
            }
                 
        }

        private void backgroundWorker1_DoWork(object sender, DoWorkEventArgs e)
        {
          MakeControl(_controlFilePath, controlSteps.start, CtrlHome.osVersion, _configClass);

           BackgroundWorker worker = sender as BackgroundWorker;
           {
               if ((worker.CancellationPending == true))
               {
                   e.Cancel = true;
               }
           }
        }

        private void backgroundWorker1_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            btViewRapport.Enabled = true;
            btStart.Enabled = true;
            btStop.Enabled = false;
            btClose.Enabled = true;
        }
        private delegate void SetTextCallback(string text);
        private void setLabel(string text)
        {
            if (this.lbMBSAscannen.InvokeRequired)
            {
                SetTextCallback d = new SetTextCallback(setLabel);
                this.Invoke(d, new object[] { text });
            }
            else
            {
                this.lbMBSAscannen.Text = text;
            }
        }
        private void setIconsByclosing(string controlStep)
        {
            if(controlStep == "start")
            {
            
            }
            if(controlStep == "passWordPolicy")
            {
                setPboxImages(1,false);
            
            }
            if(controlStep == "controlPolicy")
            {
                setPboxImages(2, false);
                
            }
            if(controlStep == "addUserGroup")
            {
                setPboxImages(3, false);
            
            }
            if(controlStep == "addUser")
            {
                setPboxImages(4, false);
           
            }
            if(controlStep == "autoPlaySettings")
            {
                setPboxImages(5, false);
            
            }
            if(controlStep == "explorerMapOptions")
            {
                setPboxImages(6, false);
            
            }
            if(controlStep == "AutologInSettings")
            {
                setPboxImages(7, false);
            
            }
            if(controlStep == "ShutDownEventTracker")
            {
                setPboxImages(8, false);
            
            }
            if(controlStep == "remoteDesktop")
            {
                setPboxImages(9, false);
            }
            if(controlStep == "sharing")
            {
                setPboxImages(10, false);
            }
            if(controlStep == "fireWall")
            {
                setPboxImages(11, false);
            }
            if(controlStep == "configPcAnywhere")
            {
                setPboxImages(12, false);
            }
            if(controlStep == "configBlockKeys")
            {
                setPboxImages(13, false);
            }
            if(controlStep == "configSQLserver")
            {
                setPboxImages(14, false);
            }
            if(controlStep == "configWebserver")
            {
                setPboxImages(15, false);
            }
            if(controlStep == "configFTPserver")
            {
                setPboxImages(16, false);
            }
            if(controlStep == "configMailserver")
            {
                setPboxImages(17, false);
            }
            if(controlStep == "configMBSA")
            {
                setPboxImages(18, false);
            }
            if (controlStep == "end")
            {
                setPboxImages(19, false);
            }
        }

    }
}
